# Kettle

## I. 可视化ETL平台 - Kettle

### E: Extract 抽取

### T: Transform 转换

### L: Load 装载

1. ### Kettle简介和安装

    ##### Kettle是一款国外开源的ETL工具

    - 纯Java开发
    - 用于数据库间的数据迁移
    - 多平台运行
    - 有图形界面, 有命令脚本, 可以二次开发
    - Kettle即水壶, 将数据放在壶里, 然后以一种指定的格式流出

    ##### Kettle环境的搭建:

    - 安装Java jdk环境(配置环境变量, 具体方法面向百度)
    - 解压Kettle软件(根据操作系统面向百度)

2. ### Kettle数据转换

    ##### 在开发中, 数据不是单一形式的, Kettle为我们提供了可靠的可视化转换形式, 其可以再多种数据源之间进行快速转换

    > ##### Kettle的基本开发步骤:
    >
    > - ##### 新建转换
    >
    > - ##### 构建Kettle数据流图
    >
    > - ##### 配置数据流图中的各个组件
    >
    > - ##### 保存并启动执行

    1. #### txt转Excel

        - ##### 新建转换: 点击窗口上的**文件 → 新建 → 转换**

        > **也可以直接使用快捷键创建：Ctrl + N**

        ![image-20220116160517801](imgs/image-20220116160517801.png)

        - ##### 构建Kettle的数据流图: 

        ![image-20220116160725901](imgs/image-20220116160725901.png)

        ![image-20220116160701820](imgs/image-20220116160701820.png)

        ![image-20220116160755860](imgs/image-20220116160755860.png)

        - ##### 配置数据流图中的各个组件:

        ![image-20220116160945606](imgs/image-20220116160945606.png)

        ![image-20220116161000490](imgs/image-20220116161000490.png)

        ![image-20220116161012432](imgs/image-20220116161012432.png)

        ![image-20220116161037474](imgs/image-20220116161037474.png)

        ![image-20220116161055001](imgs/image-20220116161055001.png)

        ![image-20220116161112232](imgs/image-20220116161112232.png)

        ![image-20220116161127132](imgs/image-20220116161127132.png)

        ![image-20220116161142506](imgs/image-20220116161142506.png)

        ![image-20220116161158590](imgs/image-20220116161158590.png)

        ![image-20220116161220263](imgs/image-20220116161220263.png)

        ![image-20220116161232718](imgs/image-20220116161232718.png)

        - ##### 保存并启动执行:

        ![image-20220116161259313](imgs/image-20220116161259313.png)

        ![image-20220116161315492](imgs/image-20220116161315492.png)

        ![image-20220116161352957](imgs/image-20220116161352957.png)

        ![image-20220116161404557](imgs/image-20220116161404557.png)

        ![image-20220116161417830](imgs/image-20220116161417830.png)

    2. #### Excel转MySQL

        - 复制MySQL jdbc驱动包到lib文件夹

            将资料中的 MySQL jdbc 驱动包`mysql-connector-java-8.0.13.jar`导入到 `data-integration/lib`中

        - 在JNDI文件夹下配置MYSQL_DB连接

            找到 data-integration\simple-jndi\jdbc.properties 文件编辑，在末尾加上连接信息: 

            ![image-20220116161704187](imgs/image-20220116161704187.png)

            ```shell
            MYSQL_DB/type=javax.sql.DataSource  
            MYSQL_DB/driver=com.mysql.cj.jdbc.Driver
            MYSQL_DB/url=jdbc:mysql://localhost:3306/kettle_demo?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=GMT
            MYSQL_DB/user=root
            MYSQL_DB/password=123456
            ```

            > ##### 注意: 账号, 密码以及数据库名称根据实际情况进行更改

            完成以上两步后重启Kettle.

        - 新建转换

        - 构建Kettle数据流图

        ![image-20220116161901418](imgs/image-20220116161901418.png)

        - 配置数据流图各组件

        ![image-20220116161934415](imgs/image-20220116161934415.png)

        ![image-20220116162026797](imgs/image-20220116162026797.png)

        ![image-20220116162043492](imgs/image-20220116162043492.png)

        ![image-20220116162100705](imgs/image-20220116162100705.png)

        ![image-20220116162110641](imgs/image-20220116162110641.png)

        ![image-20220116162121583](imgs/image-20220116162121583.png)

        ![image-20220116162134298](imgs/image-20220116162134298.png)

        ![image-20220116162146459](imgs/image-20220116162146459.png)

        ![image-20220116162158586](imgs/image-20220116162158586.png)

        ![image-20220116162310584](imgs/image-20220116162310584.png)

        ![image-20220116162329370](imgs/image-20220116162329370.png)

        ![image-20220116162342102](imgs/image-20220116162342102.png)

        ![image-20220116162353669](imgs/image-20220116162353669.png)

        ![image-20220116162405566](imgs/image-20220116162405566.png)

        ![image-20220116162416615](imgs/image-20220116162416615.png)

        ![image-20220116162425398](imgs/image-20220116162425398.png)

        ![image-20220116162438316](imgs/image-20220116162438316.png)

        - 保存并启动执行

    3. #### MySQL表间转换

        共享数据库连接

        ![image-20220116162719522](imgs/image-20220116162719522.png)

        ![image-20220116162731514](imgs/image-20220116162731514.png)

        ![image-20220116162741871](imgs/image-20220116162741871.png)

        ![image-20220116162756178](imgs/image-20220116162756178.png)

        - 新建转换
        - 构建数据流图

        ![image-20220116162815667](imgs/image-20220116162815667.png)

        - 配置数据流图各组件

        ![image-20220116162930013](imgs/image-20220116162930013.png)

        ![image-20220116163000758](imgs/image-20220116163000758.png)

        ![image-20220116163019530](imgs/image-20220116163019530.png)

        ![image-20220116163028185](imgs/image-20220116163028185.png)

        ![image-20220116163034525](imgs/image-20220116163034525.png)

        ![image-20220116163201016](imgs/image-20220116163201016.png)

        ![image-20220116163258859](imgs/image-20220116163258859.png)

        ![image-20220116163310182](imgs/image-20220116163310182.png)

        ![image-20220116163319741](imgs/image-20220116163319741.png)

        ![image-20220116163345425](imgs/image-20220116163345425.png)

        ![image-20220116163356770](imgs/image-20220116163356770.png)

        - 保存并启动执行

3. ### 插入和更新组件

    - 新建转换

    - 构建Kettle数据流图

    ![image-20220116163951141](imgs/image-20220116163951141.png)

    - 配置Kettle数据流图中的组件

    ![image-20220116164011774](imgs/image-20220116164011774.png)

    ![image-20220116164020126](imgs/image-20220116164020126.png)

    ![image-20220116164031122](imgs/image-20220116164031122.png)

    ![image-20220116164043960](imgs/image-20220116164043960.png)

    ![image-20220116164054121](imgs/image-20220116164054121.png)

    ![image-20220116164106179](imgs/image-20220116164106179.png)

    - 保存并启动执行

4. ### switch-case组件

    - 新建转换
    - 构建Kettle数据流图

    ![image-20220116165002791](imgs/image-20220116165002791.png)

    - 配置Kettle数据流图中的组件

    ![image-20220116165019096](imgs/image-20220116165019096.png)

    ![image-20220116165032875](imgs/image-20220116165032875.png)

    ![image-20220116165045878](imgs/image-20220116165045878.png)

    ![image-20220116165059656](imgs/image-20220116165059656.png)

    ![image-20220116165110771](imgs/image-20220116165110771.png)

    ![image-20220116165119486](imgs/image-20220116165119486.png)

    ![image-20220116165129278](imgs/image-20220116165129278.png)

    ![image-20220116165138726](imgs/image-20220116165138726.png)

    - 保存并启动执行

5. ### SQL脚本组件

    - 新建转换
    - 构建Kettle数据流图

    ![image-20220116165753287](imgs/image-20220116165753287.png)

    - 配置Kettle数据流图中的组件

    ![image-20220116165806940](imgs/image-20220116165806940.png)

    - 保存并启动执行

6. ### 设置转换参数

    - 新建转换
    - 构建Kettle数据流图

    - 配置Kettle数据流图中的组件

    ![image-20220116170556327](imgs/image-20220116170556327.png)

    ![image-20220116170608886](imgs/image-20220116170608886.png)

    - 保存并启动执行

    ![image-20220116170628209](imgs/image-20220116170628209.png)

7. ### 作业(job)开发

    - 新建作业
    - 构建Kettle数据流图

    ![image-20220116170705984](imgs/image-20220116170705984.png)

    - 配置Kettle作业流图中的组件

    ![image-20220116170735756](imgs/image-20220116170735756.png)

    ![image-20220116170744349](imgs/image-20220116170744349.png)

    ![image-20220116170753883](imgs/image-20220116170753883.png)

    - 保存并启动执行

8. ### 销售数据案例

    #### 需求: 将零售门店销售数据同步到总公司的服务器中

    ##### 该门店数据记录在excel中，需要定期将数据写入数据库，且该门店可能会对前一天的数据进行校验修改，同步数据的准则：

    - ##### 如果该订单已存在, 就修改其订单内容.

    - ##### 如果该订单不存在, 则新增订单.

    ##### 同步周期为一天一次, 同步时间为晚上12点, 不影响公司正常销售.

    ###### 需求抽取: 

    1. 将Excel中的数据同步到MySQL数据库中
    2. 定期同步数据
    3. 同步数据时如果订单存在就更新, 如果订单不存在就新增

    ##### 运用知识与需求实现:

    1. 创建转换: 

        - 输入: Excel输入组件

        ![image-20220116170844682](imgs/image-20220116170844682.png)

        ![image-20220116170853613](imgs/image-20220116170853613.png)

        ![image-20220116170901760](imgs/image-20220116170901760.png)

        ![image-20220116170911049](imgs/image-20220116170911049.png)

        - 输出: 插入/更新组件

        ![image-20220116170938184](imgs/image-20220116170938184.png)

        ![image-20220116170957509](imgs/image-20220116170957509.png)

        ![image-20220116171009470](imgs/image-20220116171009470.png)

        ![image-20220116171019685](imgs/image-20220116171019685.png)

    2. 创建作业

        - 定时循环启动

        ![image-20220116171038613](imgs/image-20220116171038613.png)

        - 添加转换组件

        ![image-20220116171054155](imgs/image-20220116171054155.png)

        ![image-20220116171104982](imgs/image-20220116171104982.png)

        ![image-20220116171120937](imgs/image-20220116171120937.png)

        - 添加成功组件
        - 保存并执行作业
























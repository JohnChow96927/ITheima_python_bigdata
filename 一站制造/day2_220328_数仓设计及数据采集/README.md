# 数仓设计及数据采集

## I. 数仓分层设计

### 1. 数仓设计回顾

- **目标**：**了解数据仓库设计的核心知识点**

- **路径**

  - step1：分层
  - step2：建模

- **实施**

  - **分层**：决定了数据仓库中数据库的设计

    - **什么是分层？**
      - 本质：规范化数据的处理流程
      - 实现：每一层在Hive中就是一个数据库
    - **为什么要分层？**
      - 清晰数据结构：每一个数据分层都有它的作用域，这样我们在使用表的时候能更方便地定位和理解。
      - 数据血缘追踪：简单来讲可以这样理解，我们最终给业务诚信的是一能直接使用的张业务表，但是它的来源有很多，如果有一张来源表出问题了，我们希望能够快速准确地定位到问题，并清楚它的危害范围。
      - 减少重复开发：规范数据分层，开发一些通用的中间层数据，能够减少极大的重复计算。
      - 把复杂问题简单化：一个复杂的任务分解成多个步骤来完成，每一层只处理单一的步骤，比较简单和容易理解。
      - 屏蔽原始数据的异常对业务的影响：不必改一次业务就需要重新接入数据
    - **怎么分层？**

  - **建模**：决定了数据仓库中表的设计

    - **什么是建模？**

      - 本质：决定了数据存储的方式，表的设计

    - **为什么要建模？**

      - **大数据系统需要数据模型方法来帮助更好地组织和存储数据，在性能、成本、效率和质量之间取得最佳平衡。**
      - 性能：良好的数据模型能帮助我们快速查询所需要的数据，减少数据的I/O吞吐
      - 成本：良好的数据模型能极大地减少不必要的数据冗余，也能实现计算结果复用，极大地降低大数据系统中的存储和计算成本
      - 效率：良好的数据模型能极大地改善用户使用数据的体验，提高使用数据的效率
      - 质量：良好的数据模型能改善数据统计口径的不一致性，减少数据计算错误的可能性

    - **有哪些建模方法？**

      - ER模型：从全企业的高度设计一个 3NF 【三范式】模型，用实体关系模型描述企业业务，满足业务需求的存储
      - 维度模型：从分析决策的需求出发构建模型，为分析需求服务，重点关注用户如何更快速的完成需求分析，具有较好的大规模复杂查询的响应性能
      - Data Vault：ER 模型的衍生，基于主题概念将企业数据进行结构化组织，并引入了更进一步的范式处理来优化模型，以应对源系统变更的扩展性
      - Anchor：一个高度可扩展的模型，核心思想是所有的扩展知识添加而不是修改，因此将模型规范到 6NF，基本变成了 k-v 结构化模型

    - **怎么构建维度模型步骤？**

      - a.选择业务过程：你要做什么？
      - b.声明粒度：你的分析基于什么样的颗粒度？
      - c.确认环境的维度：你的整体有哪些维度？
      - d.确认用于度量的事实：你要基于这些维度构建哪些指标？

    - **维度建模的实施流程是什么？**

      - a.需求调研

        - 业务调研：熟悉整个业务流程

        - 数据调研：业务流程中产生了哪些核心数据

        - b.划分主题域：面向业务将业务划分主题

          - 最终想要分析的有哪些主题域和主题

        - c.构建维度总线矩阵：明确每个业务主题对应的维度关系

          | 主题域主题          | 时间 | 地区 | 平台 |
          | ------------------- | ---- | ---- | ---- |
          | 运营域/订单分析主题 | *    | *    | -    |
          | 运营域/访问分析主题 | *    | -    | -    |
          | 用户域/行为分析主题 | *    | -    | *    |

        - d.明确指标统计：明确所有原生指标与衍生指标：明确每个主题要统计分析哪些指标来反映主题事实

          | 主题域主题          | 指标                                                   | 时间 | 地区 | 平台 |
          | ------------------- | ------------------------------------------------------ | ---- | ---- | ---- |
          | 运营域/订单分析主题 | 订单个数、订单金额                                     | *    | *    | -    |
          | 运营域/访问分析主题 | UV、PV、IP、跳出率、二跳率                             | *    | -    | -    |
          | 用户域/行为分析主题 | 搜索人数、浏览人数、添加购物车人数、订单人数、支付人数 | *    | -    | *    |

        - e.定义事实与维度规范

          - 建表建库规范、命名规范、开发规范

        - f.代码开发

    - **事实表**

      - 表的分类
        - 事务事实表：原始的事务事实的数据表，原始业务数据表
        - 周期快照事实表：周期性对事务事实进行聚合的结果
        - 累计快照事实表：随着时间的变化，事实是不定的，不断完善的过程
        - **无事实事实表**：特殊的事实表，里面没有事实，是多个维度的组合，用于求事实的差值
      - 值的分类
        - 可累加事实：在任何维度下指标的值都可以进行累加
        - 半可累加事实：在一定维度下指标的值都可以进行累加
      - 不可累加事实：在任何维度下指标的值都不可以进行累加

    - **维度表**

      - 维度表设计模型
        - 雪花模型：维度表拥有子维度表，部分维度表关联在维度表中，间接的关联事实表
        - **星型模型/星座模型**：维度表没有子维度，直接关联在事实表上，星座模型中有多个事实
      - 上卷与下钻
        - 上卷：从小维度到一个大的维度，颗粒度从细到粗
        - 下钻：从大维度到一个小的维度，颗粒度从粗到细
      - 拉链表
        - **渐变维度的处理方案**
        - 功能：解决事实中渐变维度发生变化的问题，通过时间来标记维度的每一种状态，存储所有状态
        - 实现
          - startTime：状态开始时间，数据产生时间
            - endTime：状态结束时间，默认为9999-12-31，用于表示最新状态
          - 流程
            - step1：先采集所有增量【新增和更新】数据到ODS层的分区中
            - step2：将更新分区的数据与老的拉链表的数据进行合并写入一张临时表
            - step3：将临时表的结果覆盖到拉链表中

- **小结**

  - 了解数据仓库设计的核心知识点

## II. 业务系统

## III. 
# 数仓设计及数据采集

## I. 数仓分层设计

### 1. 数仓设计回顾

- **目标**：**了解数据仓库设计的核心知识点**

- **路径**

  - step1：分层
  - step2：建模

- **实施**

  - **分层**：决定了数据仓库中数据库的设计

    - **什么是分层？**
      - 本质：规范化数据的处理流程
      - 实现：每一层在Hive中就是一个数据库
    - **为什么要分层？**
      - 清晰数据结构：每一个数据分层都有它的作用域，这样我们在使用表的时候能更方便地定位和理解。
      - 数据血缘追踪：简单来讲可以这样理解，我们最终给业务诚信的是一能直接使用的张业务表，但是它的来源有很多，如果有一张来源表出问题了，我们希望能够快速准确地定位到问题，并清楚它的危害范围。
      - 减少重复开发：规范数据分层，开发一些通用的中间层数据，能够减少极大的重复计算。
      - 把复杂问题简单化：一个复杂的任务分解成多个步骤来完成，每一层只处理单一的步骤，比较简单和容易理解。
      - 屏蔽原始数据的异常对业务的影响：不必改一次业务就需要重新接入数据
    - **怎么分层？**

  - **建模**：决定了数据仓库中表的设计

    - **什么是建模？**

      - 本质：决定了数据存储的方式，表的设计

    - **为什么要建模？**

      - **大数据系统需要数据模型方法来帮助更好地组织和存储数据，在性能、成本、效率和质量之间取得最佳平衡。**
      - 性能：良好的数据模型能帮助我们快速查询所需要的数据，减少数据的I/O吞吐
      - 成本：良好的数据模型能极大地减少不必要的数据冗余，也能实现计算结果复用，极大地降低大数据系统中的存储和计算成本
      - 效率：良好的数据模型能极大地改善用户使用数据的体验，提高使用数据的效率
      - 质量：良好的数据模型能改善数据统计口径的不一致性，减少数据计算错误的可能性

    - **有哪些建模方法？**

      - ER模型：从全企业的高度设计一个 3NF 【三范式】模型，用实体关系模型描述企业业务，满足业务需求的存储
      - 维度模型：从分析决策的需求出发构建模型，为分析需求服务，重点关注用户如何更快速的完成需求分析，具有较好的大规模复杂查询的响应性能
      - Data Vault：ER 模型的衍生，基于主题概念将企业数据进行结构化组织，并引入了更进一步的范式处理来优化模型，以应对源系统变更的扩展性
      - Anchor：一个高度可扩展的模型，核心思想是所有的扩展知识添加而不是修改，因此将模型规范到 6NF，基本变成了 k-v 结构化模型

    - **怎么构建维度模型步骤？**

      - a.选择业务过程：你要做什么？
      - b.声明粒度：你的分析基于什么样的颗粒度？
      - c.确认环境的维度：你的整体有哪些维度？
      - d.确认用于度量的事实：你要基于这些维度构建哪些指标？

    - **维度建模的实施流程是什么？**

      - a.需求调研

        - 业务调研：熟悉整个业务流程

        - 数据调研：业务流程中产生了哪些核心数据

        - b.划分主题域：面向业务将业务划分主题

          - 最终想要分析的有哪些主题域和主题

        - c.构建维度总线矩阵：明确每个业务主题对应的维度关系

          | 主题域主题          | 时间 | 地区 | 平台 |
          | ------------------- | ---- | ---- | ---- |
          | 运营域/订单分析主题 | *    | *    | -    |
          | 运营域/访问分析主题 | *    | -    | -    |
          | 用户域/行为分析主题 | *    | -    | *    |

        - d.明确指标统计：明确所有原生指标与衍生指标：明确每个主题要统计分析哪些指标来反映主题事实

          | 主题域主题          | 指标                                                   | 时间 | 地区 | 平台 |
          | ------------------- | ------------------------------------------------------ | ---- | ---- | ---- |
          | 运营域/订单分析主题 | 订单个数、订单金额                                     | *    | *    | -    |
          | 运营域/访问分析主题 | UV、PV、IP、跳出率、二跳率                             | *    | -    | -    |
          | 用户域/行为分析主题 | 搜索人数、浏览人数、添加购物车人数、订单人数、支付人数 | *    | -    | *    |

        - e.定义事实与维度规范

          - 建表建库规范、命名规范、开发规范

        - f.代码开发

    - **事实表**

      - 表的分类
        - 事务事实表：原始的事务事实的数据表，原始业务数据表
        - 周期快照事实表：周期性对事务事实进行聚合的结果
        - 累计快照事实表：随着时间的变化，事实是不定的，不断完善的过程
        - **无事实事实表**：特殊的事实表，里面没有事实，是多个维度的组合，用于求事实的差值
      - 值的分类
        - 可累加事实：在任何维度下指标的值都可以进行累加
        - 半可累加事实：在一定维度下指标的值都可以进行累加
      - 不可累加事实：在任何维度下指标的值都不可以进行累加

    - **维度表**

      - 维度表设计模型
        - 雪花模型：维度表拥有子维度表，部分维度表关联在维度表中，间接的关联事实表
        - **星型模型/星座模型**：维度表没有子维度，直接关联在事实表上，星座模型中有多个事实
      - 上卷与下钻
        - 上卷：从小维度到一个大的维度，颗粒度从细到粗
        - 下钻：从大维度到一个小的维度，颗粒度从粗到细
      - 拉链表
        - **渐变维度的处理方案**
        - 功能：解决事实中渐变维度发生变化的问题，通过时间来标记维度的每一种状态，存储所有状态
        - 实现
          - startTime：状态开始时间，数据产生时间
            - endTime：状态结束时间，默认为9999-12-31，用于表示最新状态
          - 流程
            - step1：先采集所有增量【新增和更新】数据到ODS层的分区中
            - step2：将更新分区的数据与老的拉链表的数据进行合并写入一张临时表
            - step3：将临时表的结果覆盖到拉链表中

- **小结**

  - 了解数据仓库设计的核心知识点

### 2. 分层整体设计

- **目标**：**掌握油站分析项目中的分层整体设计**

- **实施**

  ![image-20210821102418366](assets/image-20210821102418366.png)

  - **ODS**：原始数据层：最接近于原始数据的层次，直接采集写入层次
  - **DWD**：明细数据层：对ODS层的数据根据业务需求实现数据清洗以后的结果，保证数据质量
  - **DWB**：基础数据层：轻度聚合，有的公司也叫作DWM
  - **DWS**：等同于DIM，维度数据层：存储维度数据表
  - **ST**：数据应用层：存储每个主题基于维度分析聚合的结果，只用于对外提供报表
  - **DM**：数据集市：按照不同部门的数据需求，将暂时没有实际主题需求的数据存储

- **小结**

  - 掌握油站分析项目中的分层整体设计

### 3. 分层具体功能

- **目标**：**掌握油站分析的每层的具体功能**
- **实施**
  - **ODS**
    - 数据内容：存储所有原始业务数据，基本与Oracle数据库中的业务数据保持一致
    - 数据来源：使用Sqoop从Oracle中同步采集
    - 存储设计：Hive分区表，avro文件格式存储，保留3个月
    - 数据表：事务事实表 + 维度表
  - **DWD**
    - 数据内容：存储所有业务数据的明细数据
    - 数据来源：对ODS层的数据进行ETL扁平化处理得到，保证数据质量
    - 存储设计：Hive分区表，orc文件格式存储，保留所有数据
    - 数据表：事务事实表 + 维度表，对ODS做了清洗
  - **DWB**
    - 数据内容：存储所有事实与维度的基本关联、基本事实指标等数据
    - 数据来源：对DWD层的数据进行清洗过滤、**轻度聚合**以后的数据
    - 存储设计：Hive分区表，orc文件格式存储，保留所有数据
    - 数据表：主题事务事实表
  - **DWS**
    - 数据内容：存储所有业务的维度数据：日期、地区、油站、呼叫中心、仓库等维度表
    - 数据来源：对DWD的明细数据中抽取维度数据，通过工具生成维度数据
    - 存储设计：Hive普通表，orc文件 + Snappy压缩
    - 数据表：维度表
  - **ST**
    - 数据内容：存储所有报表分析的事实数据
    - 数据来源：基于DWB和DWS层，通过对不同维度的统计聚合得到所有报表事实的指标
    - 数据表：周期快照事实表
  - **DM**
    - 数据内容：存储不同部门所需要的不同主题的数据
    - 数据来源：对DW层的数据进行聚合统计按照不同部门划分
    - 数据表：每个部门需要的数据宽表
- **小结**
  - 掌握油站分析的每层的具体功能

## II. 业务系统

### 1. 业务系统结构

- **目标**：**了解一站制造中的业务系统结构**

- **实施**

  - **数据来源**：业务系统

    <img src="E:/Heima/%E5%B0%B1%E4%B8%9A%E7%8F%AD%E6%95%99%E5%B8%88%E5%86%85%E5%AE%B9%EF%BC%88%E6%AF%8F%E6%97%A5%E6%9B%B4%E6%96%B0%EF%BC%89/%E4%B8%80%E7%AB%99%E5%88%B6%E9%80%A0%E9%A1%B9%E7%9B%AE/%E8%AF%BE%E5%89%8D%E7%AC%94%E8%AE%B0_Day02_%E6%95%B0%E4%BB%93%E8%AE%BE%E8%AE%A1%E5%8F%8A%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86/2.%E7%AC%94%E8%AE%B0/Day02_%E6%95%B0%E4%BB%93%E8%AE%BE%E8%AE%A1%E5%8F%8A%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86.assets/image-20210821104106361.png" alt="image-20210821104106361" style="zoom:67%;" />

    - **ERP系统**：企业资源管理系统，存储整个公司所有资源的信息
      - 员工部门信息、仓库信息、设备信息
    - **CISS系统**：客户服务管理系统，存储所有用户、运营数据
      - 油站信息、工单信息
    - **呼叫中心系统**：负责实现所有客户的需求申请、调度、回访等
      - 来电信息、回访信息

  - **组织结构**

    - 运营部（编制人数300人）
      - 负责服务策略制定和实施，对服务网络运营过程管理。部门职能包括物料管理、技术支持、服务效率管理、服务质量控制、服务标准化和可视化实施等工作。承担公司基础服务管理方面具体目标责任
    - 综合管理部（编制人数280人）
      - 下属部门有呼叫中心、信息运维、人事行政、绩效考核与培训、企划部等部门。负责公司市场部、运营部、财务部等专业业务以外的所有职能类工作，包括行政后勤管理、劳动关系、绩效考核与培训、企划宣传、采购需求管理、信息建设及数据分析、公司整体目标和绩效管理等工作。
    - 市场部（编制人数50人）
      - 负责客户需求开发、服务产品开发、市场拓展与销售管理工作，执行销售策略、承担公司市场、销售方面具体目标责任。
    - 财务部（编制人数10人）
      - 负责服务公司财务收支、费用报销、报表统计、财务分析等财务管理工作
    - 市场销售服务中心（编制人数4000人）
      - 负责服务产品销售，设备的安装、维护、修理、改造等工作，严格按照公司管理标准实施日常服务工作

  - **业务流程**

    ![image-20210821152108191](E:/Heima/%E5%B0%B1%E4%B8%9A%E7%8F%AD%E6%95%99%E5%B8%88%E5%86%85%E5%AE%B9%EF%BC%88%E6%AF%8F%E6%97%A5%E6%9B%B4%E6%96%B0%EF%BC%89/%E4%B8%80%E7%AB%99%E5%88%B6%E9%80%A0%E9%A1%B9%E7%9B%AE/%E8%AF%BE%E5%89%8D%E7%AC%94%E8%AE%B0_Day02_%E6%95%B0%E4%BB%93%E8%AE%BE%E8%AE%A1%E5%8F%8A%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86/2.%E7%AC%94%E8%AE%B0/Day02_%E6%95%B0%E4%BB%93%E8%AE%BE%E8%AE%A1%E5%8F%8A%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86.assets/1.png)

    

- **小结**

  - 了解一站制造中的业务系统结构

### 2. 业务系统数据

- **目标**：**熟悉业务系统核心数据表**

- **实施**

  - **切换查看数据库**

    ![image-20210821121346141](E:/Heima/%E5%B0%B1%E4%B8%9A%E7%8F%AD%E6%95%99%E5%B8%88%E5%86%85%E5%AE%B9%EF%BC%88%E6%AF%8F%E6%97%A5%E6%9B%B4%E6%96%B0%EF%BC%89/%E4%B8%80%E7%AB%99%E5%88%B6%E9%80%A0%E9%A1%B9%E7%9B%AE/%E8%AF%BE%E5%89%8D%E7%AC%94%E8%AE%B0_Day02_%E6%95%B0%E4%BB%93%E8%AE%BE%E8%AE%A1%E5%8F%8A%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86/2.%E7%AC%94%E8%AE%B0/Day02_%E6%95%B0%E4%BB%93%E8%AE%BE%E8%AE%A1%E5%8F%8A%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86.assets/image-20210821121346141.png)

  - **查看数据表**

    - CISS_BASE：基础数据表：维度表 + 字典表
      - 报销项目核算、地区信息、服务商信息、设备信息、故障分类、出差补助信息、油站基础信息等
    - CISS_SERVICE、CISS_S：服务数据表
      - 来电受理单信息、改派记录信息、故障更换材料明细信息、综合报销信息、服务单信息、安装单、维修单、改造单信息、巡检单信息
    - CISS_MATERIAL、CISS_M：仓储物料表
      - 物料申明明细信息、网点物料调配申请等
    - ORG：组织机构数据
      - 部门信息、员工信息等
    - EOS：字典信息表
      - 存放不同状态标识的字典

  - **核心数据表**

    ![image-20210821134859278](E:/Heima/%E5%B0%B1%E4%B8%9A%E7%8F%AD%E6%95%99%E5%B8%88%E5%86%85%E5%AE%B9%EF%BC%88%E6%AF%8F%E6%97%A5%E6%9B%B4%E6%96%B0%EF%BC%89/%E4%B8%80%E7%AB%99%E5%88%B6%E9%80%A0%E9%A1%B9%E7%9B%AE/%E8%AF%BE%E5%89%8D%E7%AC%94%E8%AE%B0_Day02_%E6%95%B0%E4%BB%93%E8%AE%BE%E8%AE%A1%E5%8F%8A%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86/2.%E7%AC%94%E8%AE%B0/Day02_%E6%95%B0%E4%BB%93%E8%AE%BE%E8%AE%A1%E5%8F%8A%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86.assets/image-20210821134859278.png)

    - 运营分析：工单分析、来电分析
    - 提高服务质量：回访分析
    - 运营成本核算：费用分析

- **小结**

  - 熟悉业务系统核心数据表

## III. 数据采集

### 1. 全量与增量分析

- **目标**：**了解全量表与增量表数据采集需求**

- **实施**

  - **全量表：**

    - 所有**维度数据表**

    - 场景：不会经常发生变化的数据表，例如维度数据表等

    - 数据表：组织机构信息、地区信息、服务商信息、数据字典等

    - 表名：参考文件《full_import_tables.txt》

      ![image-20211101114104721](E:/Heima/%E5%B0%B1%E4%B8%9A%E7%8F%AD%E6%95%99%E5%B8%88%E5%86%85%E5%AE%B9%EF%BC%88%E6%AF%8F%E6%97%A5%E6%9B%B4%E6%96%B0%EF%BC%89/%E4%B8%80%E7%AB%99%E5%88%B6%E9%80%A0%E9%A1%B9%E7%9B%AE/%E8%AF%BE%E5%89%8D%E7%AC%94%E8%AE%B0_Day02_%E6%95%B0%E4%BB%93%E8%AE%BE%E8%AE%A1%E5%8F%8A%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86/2.%E7%AC%94%E8%AE%B0/Day02_%E6%95%B0%E4%BB%93%E8%AE%BE%E8%AE%A1%E5%8F%8A%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86.assets/image-20211101114104721.png)

  - **增量表**

    - 所有**事务事实的数据表**

    - 场景：经常发生变化的数据表，例如业务数据、用户行为数据等

    - 数据表：工单数据信息、呼叫中心信息、物料仓储信息、报销费用信息等

    - 表名：参考文件《incr_import_tables.txt》

      ![image-20211101114131787](E:/Heima/%E5%B0%B1%E4%B8%9A%E7%8F%AD%E6%95%99%E5%B8%88%E5%86%85%E5%AE%B9%EF%BC%88%E6%AF%8F%E6%97%A5%E6%9B%B4%E6%96%B0%EF%BC%89/%E4%B8%80%E7%AB%99%E5%88%B6%E9%80%A0%E9%A1%B9%E7%9B%AE/%E8%AF%BE%E5%89%8D%E7%AC%94%E8%AE%B0_Day02_%E6%95%B0%E4%BB%93%E8%AE%BE%E8%AE%A1%E5%8F%8A%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86/2.%E7%AC%94%E8%AE%B0/Day02_%E6%95%B0%E4%BB%93%E8%AE%BE%E8%AE%A1%E5%8F%8A%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86.assets/image-20211101114131787.png)

  - 整体需求：将Oracle中101张表的数据通过全量或者增量同步到Hive的ODS层中

- **小结**

  - 了解全量表与增量表数据采集需求

